{% extends "base.html" %}
{% block title %}Alerts{% endblock %}
{% block content %}
<h4 class="mb-4"><i class="bi bi-bell"></i> Alerts <span class="badge bg-secondary">{{ alerts|length }}</span></h4>

<form method="get" class="filter-bar row g-2 mb-4">
    <div class="col-md-3">
        <select name="level" class="form-select form-select-sm">
            <option value="">All Levels</option>
            {% for lvl in AlertLevel %}
            <option value="{{ lvl.value }}" {% if filters.level == lvl.value %}selected{% endif %}>{{ lvl.value|upper }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="col-md-3">
        <select name="type" class="form-select form-select-sm">
            <option value="">All Types</option>
            {% for t in AlertType %}
            <option value="{{ t.value }}" {% if filters.type == t.value %}selected{% endif %}>{{ t.value|replace('_', ' ')|title }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="col-md-3">
        <input type="text" name="vendor" class="form-control form-control-sm" placeholder="Vendor" value="{{ filters.vendor or '' }}">
    </div>
    <div class="col-md-3">
        <button type="submit" class="btn btn-outline-secondary btn-sm w-100"><i class="bi bi-funnel"></i> Filter</button>
    </div>
</form>

<div class="card">
    <div class="card-body">
        {% if alerts %}
        <div class="table-responsive">
            <table class="table table-sm table-hover mb-0">
                {% from "macros/sort_header.html" import sort_th %}
                <thead>
                    <tr>
                        {{ sort_th("Level", "level", sort_field, sort_order) }}
                        {{ sort_th("Product", "product", sort_field, sort_order) }}
                        {{ sort_th("Vendor", "vendor", sort_field, sort_order) }}
                        {{ sort_th("Type", "type", sort_field, sort_order) }}
                        {{ sort_th("Days Remaining", "days", sort_field, sort_order) }}
                        {{ sort_th("Target Date", "date", sort_field, sort_order) }}
                        <th>Message</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for alert in alerts %}
                    <tr>
                        <td><span class="badge badge-{{ alert.alert_level.value }}">{{ alert.alert_level.value|upper }}</span></td>
                        <td>{{ alert.product_name }}</td>
                        <td>{{ alert.vendor }}</td>
                        <td>{{ alert.alert_type.value|replace('_', ' ')|title }}</td>
                        <td>{{ alert.days_remaining }}</td>
                        <td>{{ alert.target_date.strftime('%Y-%m-%d') }}</td>
                        <td><small>{{ alert.message }}</small></td>
                        <td>
                            {% if not alert.acknowledged %}
                            <form method="post" action="{{ url_for('alerts.acknowledge') }}" style="display:inline">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <input type="hidden" name="product_id" value="{{ alert.product_id }}">
                                <input type="hidden" name="alert_type" value="{{ alert.alert_type.value }}">
                                <button type="submit" class="btn btn-sm btn-outline-success" title="Acknowledge"><i class="bi bi-check-lg"></i></button>
                            </form>
                            {% else %}
                            <span class="badge bg-success"><i class="bi bi-check"></i> Acked</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state">
            <i class="bi bi-shield-check"></i>
            <p>No alerts match your filters.</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
