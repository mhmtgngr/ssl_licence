{% extends "base.html" %}
{% block title %}{{ domain.hostname }}{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h4>
        <i class="bi bi-globe2"></i> {{ domain.hostname }}
        <span class="badge bg-light text-dark ms-2">{{ domain.domain_type.value|title }}</span>
        {% if domain.auto_discovered %}<span class="badge bg-secondary ms-1">Auto-discovered</span>{% endif %}
    </h4>
    <div>
        <form method="post" action="{{ url_for('domains.refresh_domain', domain_id=domain.domain_id) }}" style="display:inline">
            <button type="submit" class="btn btn-outline-primary"><i class="bi bi-arrow-clockwise"></i> Refresh</button>
        </form>
        <a href="{{ url_for('domains.edit_domain', domain_id=domain.domain_id) }}" class="btn btn-outline-secondary"><i class="bi bi-pencil"></i> Edit</a>
        <form method="post" action="{{ url_for('domains.delete_domain', domain_id=domain.domain_id) }}" style="display:inline">
            <button type="submit" class="btn btn-outline-danger" onclick="return confirm('Delete {{ domain.hostname }}?')"><i class="bi bi-trash"></i> Delete</button>
        </form>
        <a href="{{ url_for('domains.list_domains') }}" class="btn btn-outline-secondary"><i class="bi bi-arrow-left"></i> Back</a>
    </div>
</div>

{# Summary cards #}
<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="card card-stat {{ 'text-bg-success' if domain.ssl_status == 'ok' else 'text-bg-warning' if domain.ssl_status == 'warning' else 'text-bg-danger' if domain.ssl_status in ('expired', 'fail') else 'text-bg-secondary' }}">
            <div class="card-body">
                <h6><i class="bi bi-shield-lock"></i> SSL Certificate</h6>
                <h2>
                    {% if domain.ssl_status == 'ok' %}OK
                    {% elif domain.ssl_status == 'warning' %}WARNING
                    {% elif domain.ssl_status == 'expired' %}EXPIRED
                    {% elif domain.ssl_status == 'fail' %}FAIL
                    {% else %}-{% endif %}
                </h2>
                <small>
                    {% if domain.ssl_days_remaining is not none %}{{ domain.ssl_days_remaining }}d remaining{% else %}Not checked{% endif %}
                </small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card card-stat {{ 'text-bg-danger' if domain.registration_days_remaining is not none and domain.registration_days_remaining < 30 else 'text-bg-warning' if domain.registration_days_remaining is not none and domain.registration_days_remaining < 90 else 'text-bg-info' if domain.registration_expiry else 'text-bg-secondary' }}">
            <div class="card-body">
                <h6><i class="bi bi-calendar-event"></i> Domain Registration</h6>
                <h2>{% if domain.registration_days_remaining is not none %}{{ domain.registration_days_remaining }}d{% else %}N/A{% endif %}</h2>
                <small>{% if domain.registration_expiry %}Expires {{ domain.registration_expiry.strftime('%Y-%m-%d') }}{% else %}No WHOIS data{% endif %}</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card card-stat {{ 'text-bg-primary' if domain.ip_address else 'text-bg-secondary' }}">
            <div class="card-body">
                <h6><i class="bi bi-diagram-3"></i> DNS</h6>
                <h2><code style="color:inherit;">{{ domain.ip_address or 'N/A' }}</code></h2>
                <small>{{ domain.nameservers|length }} nameserver{{ 's' if domain.nameservers|length != 1 }}</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card card-stat {{ 'text-bg-dark' if domain.hosting_provider else 'text-bg-secondary' }}">
            <div class="card-body">
                <h6><i class="bi bi-hdd-rack"></i> Hosting</h6>
                <h2>{{ domain.hosting_provider or 'Unknown' }}</h2>
                <small>{{ domain.reverse_dns or 'No rDNS' }}</small>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    {# SSL Details #}
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header"><i class="bi bi-shield-lock"></i> SSL Certificate Details</div>
            <div class="card-body">
                <table class="table table-sm mb-0">
                    <tbody>
                        <tr><th style="width:40%;">Status</th><td>
                            {% if domain.ssl_status == 'ok' %}<span class="badge bg-success">OK</span>
                            {% elif domain.ssl_status == 'warning' %}<span class="badge bg-warning text-dark">WARNING</span>
                            {% elif domain.ssl_status == 'expired' %}<span class="badge bg-danger">EXPIRED</span>
                            {% elif domain.ssl_status == 'fail' %}<span class="badge bg-dark">FAIL</span>
                            {% else %}<span class="badge bg-secondary">Not checked</span>{% endif %}
                        </td></tr>
                        <tr><th>Issuer</th><td>{{ domain.ssl_issuer or '-' }}</td></tr>
                        <tr><th>Expiry Date</th><td>{{ domain.ssl_expiry.strftime('%Y-%m-%d %H:%M UTC') if domain.ssl_expiry else '-' }}</td></tr>
                        <tr><th>Days Remaining</th><td>
                            {% if domain.ssl_days_remaining is not none %}
                            <span class="fw-semibold text-{{ 'danger' if domain.ssl_status == 'expired' else 'warning' if domain.ssl_status == 'warning' else 'success' }}">
                                {{ domain.ssl_days_remaining }}
                            </span>
                            {% else %}-{% endif %}
                        </td></tr>
                        <tr><th>Warning Threshold</th><td>{{ domain.warning_days }} days</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    {# DNS Details #}
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header"><i class="bi bi-diagram-3"></i> DNS Information</div>
            <div class="card-body">
                <table class="table table-sm mb-0">
                    <tbody>
                        <tr><th style="width:40%;">IP Address</th><td><code>{{ domain.ip_address or '-' }}</code></td></tr>
                        <tr><th>Reverse DNS</th><td><small>{{ domain.reverse_dns or '-' }}</small></td></tr>
                        <tr><th>Hosting Provider</th><td>{{ domain.hosting_provider or '-' }}</td></tr>
                        <tr><th>Nameservers</th><td>
                            {% if domain.nameservers %}
                            {% for ns in domain.nameservers %}
                            <div><small><code>{{ ns }}</code></small></div>
                            {% endfor %}
                            {% else %}-{% endif %}
                        </td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

{# Registration / WHOIS #}
<div class="row g-4">
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header"><i class="bi bi-calendar-event"></i> Domain Registration (WHOIS)</div>
            <div class="card-body">
                <table class="table table-sm mb-0">
                    <tbody>
                        <tr><th style="width:40%;">Registrar</th><td>{{ domain.registrar or '-' }}</td></tr>
                        <tr><th>Registration Expiry</th><td>{{ domain.registration_expiry.strftime('%Y-%m-%d %H:%M UTC') if domain.registration_expiry else '-' }}</td></tr>
                        <tr><th>Days Remaining</th><td>
                            {% if domain.registration_days_remaining is not none %}
                            <span class="fw-semibold text-{{ 'danger' if domain.registration_days_remaining < 30 else 'warning' if domain.registration_days_remaining < 90 else 'success' }}">
                                {{ domain.registration_days_remaining }}
                            </span>
                            {% else %}-{% endif %}
                        </td></tr>
                        <tr><th>Created Date</th><td>{{ domain.domain_created_date.strftime('%Y-%m-%d') if domain.domain_created_date else '-' }}</td></tr>
                        <tr><th>DNSSEC</th><td>
                            {% if domain.dnssec %}
                            <span class="badge bg-{{ 'success' if 'signed' in domain.dnssec.lower() or domain.dnssec.lower() == 'yes' else 'secondary' }}">{{ domain.dnssec|upper }}</span>
                            {% else %}-{% endif %}
                        </td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header"><i class="bi bi-lock"></i> Let's Encrypt</div>
            <div class="card-body">
                {% if domain.le_enabled %}
                <table class="table table-sm mb-3">
                    <tbody>
                        <tr><th style="width:40%;">Status</th><td><span class="badge bg-success">Enabled</span></td></tr>
                        <tr><th>Certificate</th><td><code class="small">{{ domain.le_cert_path or '-' }}</code></td></tr>
                        <tr><th>Key</th><td><code class="small">{{ domain.le_key_path or '-' }}</code></td></tr>
                        <tr><th>Last Renewed</th><td>{{ domain.le_last_renewed.strftime('%Y-%m-%d %H:%M UTC') if domain.le_last_renewed else 'Never' }}</td></tr>
                        <tr><th>Challenge</th><td>{{ domain.le_challenge_type|upper }}</td></tr>
                        <tr><th>Auto-Renewal</th><td>
                            <span class="badge bg-{{ 'success' if domain.le_auto_renew else 'secondary' }}">{{ 'ON' if domain.le_auto_renew else 'OFF' }}</span>
                            <form method="post" action="{{ url_for('domains.toggle_auto_renew', domain_id=domain.domain_id) }}" style="display:inline">
                                <button type="submit" class="btn btn-sm btn-outline-secondary ms-2">{{ 'Disable' if domain.le_auto_renew else 'Enable' }}</button>
                            </form>
                        </td></tr>
                    </tbody>
                </table>
                <form method="post" action="{{ url_for('domains.renew_letsencrypt', domain_id=domain.domain_id) }}" style="display:inline">
                    <button type="submit" class="btn btn-sm btn-outline-primary"><i class="bi bi-arrow-clockwise"></i> Renew Now</button>
                </form>
                {% else %}
                <p class="text-muted mb-3">No Let's Encrypt certificate issued for this domain.</p>
                <form method="post" action="{{ url_for('domains.issue_letsencrypt', domain_id=domain.domain_id) }}">
                    <div class="row g-2 align-items-end">
                        <div class="col-auto">
                            <label class="form-label">Challenge</label>
                            <select name="challenge_type" class="form-select form-select-sm">
                                <option value="http">HTTP-01 (Standalone)</option>
                                <option value="dns">DNS-01 (Manual)</option>
                            </select>
                        </div>
                        <div class="col-auto">
                            <div class="form-check mt-4">
                                <input class="form-check-input" type="checkbox" name="auto_renew" id="autoRenew">
                                <label class="form-check-label" for="autoRenew">Auto-renew</label>
                            </div>
                        </div>
                        <div class="col-auto">
                            <button type="submit" class="btn btn-sm btn-primary" onclick="return confirm('Issue Let\\'s Encrypt certificate for {{ domain.hostname }}?\\nPort 80 must be available for HTTP challenge.')">
                                <i class="bi bi-lock"></i> Issue Certificate
                            </button>
                        </div>
                    </div>
                </form>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{# SOA Record #}
{% if domain.soa_primary_ns %}
<div class="card mb-4">
    <div class="card-header"><i class="bi bi-card-list"></i> SOA Record</div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <table class="table table-sm mb-0">
                    <tbody>
                        <tr><th style="width:40%;">Primary NS</th><td><code>{{ domain.soa_primary_ns }}</code></td></tr>
                        <tr><th>Admin Email</th><td>{{ domain.soa_admin_email }}</td></tr>
                        <tr><th>Serial</th><td><code>{{ domain.soa_serial }}</code></td></tr>
                    </tbody>
                </table>
            </div>
            <div class="col-md-6">
                <table class="table table-sm mb-0">
                    <tbody>
                        <tr><th style="width:40%;">Refresh</th><td>{{ domain.soa_refresh }}s ({{ (domain.soa_refresh / 3600)|round(1) }}h)</td></tr>
                        <tr><th>Retry</th><td>{{ domain.soa_retry }}s ({{ (domain.soa_retry / 60)|round(0)|int }}m)</td></tr>
                        <tr><th>Expire</th><td>{{ domain.soa_expire }}s ({{ (domain.soa_expire / 86400)|round(1) }}d)</td></tr>
                        <tr><th>Minimum TTL</th><td>{{ domain.soa_minimum_ttl }}s</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endif %}

{# Metadata #}
<div class="card mb-4">
    <div class="card-header"><i class="bi bi-info-circle"></i> Metadata</div>
    <div class="card-body">
        <table class="table table-sm mb-0">
            <tbody>
                <tr><th style="width:20%;">Parent Domain</th><td>{{ domain.parent_domain or '-' }}</td></tr>
                <tr><th>Domain Type</th><td><span class="badge bg-light text-dark">{{ domain.domain_type.value|title }}</span></td></tr>
                <tr><th>Status</th><td>
                    <span class="badge bg-{{ 'success' if domain.status.value == 'active' else 'warning' if domain.status.value == 'expiring' else 'danger' if domain.status.value in ('expired', 'unreachable') else 'secondary' }}">
                        {{ domain.status.value|upper }}
                    </span>
                </td></tr>
                <tr><th>Tags</th><td>
                    {% if domain.tags %}
                    {% for tag in domain.tags %}<span class="badge bg-light text-dark me-1">{{ tag }}</span>{% endfor %}
                    {% else %}-{% endif %}
                </td></tr>
                <tr><th>Notes</th><td>{{ domain.notes or '-' }}</td></tr>
                <tr><th>Last Checked</th><td>{{ domain.last_checked.strftime('%Y-%m-%d %H:%M UTC') if domain.last_checked else 'Never' }}</td></tr>
                <tr><th>Created</th><td>{{ domain.created_at.strftime('%Y-%m-%d %H:%M UTC') }}</td></tr>
                <tr><th>Updated</th><td>{{ domain.updated_at.strftime('%Y-%m-%d %H:%M UTC') }}</td></tr>
            </tbody>
        </table>
    </div>
</div>
{% endblock %}
