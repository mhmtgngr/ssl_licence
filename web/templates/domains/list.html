{% extends "base.html" %}
{% block title %}Domains{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h4><i class="bi bi-globe2"></i> Domains</h4>
    <div>
        <a href="{{ url_for('domains.export_domains') }}" class="btn btn-outline-secondary"><i class="bi bi-download"></i> Export CSV</a>
        <form method="post" action="{{ url_for('domains.refresh_all') }}" style="display:inline" data-confirm="Refresh all {{ summary.total_domains }} domains in background?">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn btn-outline-warning"><i class="bi bi-arrow-repeat"></i> Refresh All</button>
        </form>
        <a href="{{ url_for('domains.azure_resources') }}" class="btn btn-outline-info"><i class="bi bi-cloud-check"></i> Azure Resources</a>
        <a href="{{ url_for('domains.import_domains') }}" class="btn btn-outline-success"><i class="bi bi-cloud-download"></i> Import</a>
        <a href="{{ url_for('domains.discover') }}" class="btn btn-outline-primary"><i class="bi bi-search"></i> Discover Subdomains</a>
        <a href="{{ url_for('domains.add_domain') }}" class="btn btn-primary"><i class="bi bi-plus-lg"></i> Add Domain</a>
    </div>
</div>

{# Summary cards #}
<div class="row g-3 mb-4">
    <div class="col-md-3">
        <a href="{{ url_for('domains.list_domains') }}" class="text-decoration-none">
        <div class="card card-stat text-bg-primary {{ 'border border-3 border-dark' if not ssl_status_filter and not expiry_range_filter }}">
            <div class="card-body"><h6><i class="bi bi-globe2"></i> Total Domains</h6><h2>{{ summary.total_domains }}</h2></div>
        </div>
        </a>
    </div>
    <div class="col-md-3">
        <a href="{{ url_for('domains.list_domains', ssl_status='ok') }}" class="text-decoration-none">
        <div class="card card-stat text-bg-success {{ 'border border-3 border-dark' if ssl_status_filter == 'ok' }}">
            <div class="card-body"><h6><i class="bi bi-shield-check"></i> SSL OK</h6><h2>{{ summary.ssl_ok }}</h2></div>
        </div>
        </a>
    </div>
    <div class="col-md-3">
        <a href="{{ url_for('domains.list_domains', ssl_status='warning') }}" class="text-decoration-none">
        <div class="card card-stat text-bg-warning {{ 'border border-3 border-dark' if ssl_status_filter == 'warning' }}">
            <div class="card-body"><h6><i class="bi bi-exclamation-triangle"></i> SSL Expiring</h6><h2>{{ summary.ssl_warning }}</h2></div>
        </div>
        </a>
    </div>
    <div class="col-md-3">
        <a href="{{ url_for('domains.list_domains', ssl_status='fail') }}" class="text-decoration-none">
        <div class="card card-stat text-bg-danger {{ 'border border-3 border-dark' if ssl_status_filter in ('fail', 'expired') }}">
            <div class="card-body"><h6><i class="bi bi-x-circle"></i> SSL Expired/Fail</h6><h2>{{ summary.ssl_expired }}</h2></div>
        </div>
        </a>
    </div>
</div>

{% if active_filters %}
<div class="mb-3">
    <span class="text-muted small me-2">Filtered by:</span>
    {% for label, value in active_filters %}
    <span class="badge bg-primary me-1">{{ label }}: {{ value }}</span>
    {% endfor %}
    <a href="{{ url_for('domains.list_domains') }}" class="badge bg-secondary text-decoration-none ms-1">Clear All</a>
    <span class="text-muted small ms-2">({{ domains|length }} result{{ 's' if domains|length != 1 }})</span>
</div>
{% endif %}

{# Filters #}
<form method="get" class="filter-bar row g-2 mb-4 align-items-center">
    <div class="col-auto">
        <input type="text" name="q" class="form-control form-control-sm" placeholder="Search..." value="{{ q }}" style="width:180px;">
    </div>
    <div class="col-auto">
        <select name="status" class="form-select form-select-sm">
            <option value="">All Statuses</option>
            {% for s in DomainStatus %}
            <option value="{{ s.value }}" {% if status_filter == s.value %}selected{% endif %}>{{ s.value|replace('_', ' ')|title }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="col-auto">
        <select name="ssl_status" class="form-select form-select-sm">
            <option value="">All SSL</option>
            <option value="ok" {% if ssl_status_filter == 'ok' %}selected{% endif %}>OK</option>
            <option value="warning" {% if ssl_status_filter == 'warning' %}selected{% endif %}>Warning</option>
            <option value="expired" {% if ssl_status_filter == 'expired' %}selected{% endif %}>Expired</option>
            <option value="fail" {% if ssl_status_filter == 'fail' %}selected{% endif %}>Fail</option>
        </select>
    </div>
    <div class="col-auto">
        <select name="type" class="form-select form-select-sm">
            <option value="">All Types</option>
            {% for t in DomainType %}
            <option value="{{ t.value }}" {% if type_filter == t.value %}selected{% endif %}>{{ t.value|title }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="col-auto">
        <select name="parent" class="form-select form-select-sm">
            <option value="">All Parents</option>
            {% for p in parents %}
            <option value="{{ p }}" {% if parent_filter == p %}selected{% endif %}>{{ p }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="col-auto">
        <select name="cert_type" class="form-select form-select-sm">
            <option value="">All Cert Types</option>
            {% for ct in CertificateType %}
            <option value="{{ ct.value }}" {% if cert_type_filter == ct.value %}selected{% endif %}>{{ ct.value|title }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="col-auto">
        <select name="ca" class="form-select form-select-sm">
            <option value="">All CAs</option>
            {% for ca in ca_names %}
            <option value="{{ ca }}" {% if ca_filter == ca %}selected{% endif %}>{{ ca }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="col-auto">
        <select name="expiry_range" class="form-select form-select-sm">
            <option value="">All Expiry</option>
            <option value="0-30" {% if expiry_range_filter == '0-30' %}selected{% endif %}>0–30 days</option>
            <option value="31-60" {% if expiry_range_filter == '31-60' %}selected{% endif %}>31–60 days</option>
            <option value="61-90" {% if expiry_range_filter == '61-90' %}selected{% endif %}>61–90 days</option>
            <option value="91-180" {% if expiry_range_filter == '91-180' %}selected{% endif %}>91–180 days</option>
            <option value="180+" {% if expiry_range_filter == '180+' %}selected{% endif %}>180+ days</option>
        </select>
    </div>
    <div class="col-auto">
        <button type="submit" class="btn btn-outline-secondary btn-sm">Filter</button>
        {% if q or status_filter or type_filter or parent_filter or cert_type_filter or ca_filter or ssl_status_filter or expiry_range_filter or hosting_filter %}
        <a href="{{ url_for('domains.list_domains') }}" class="btn btn-outline-secondary btn-sm">Clear</a>
        {% endif %}
    </div>
    <div class="col-auto ms-auto">
        <div class="btn-group btn-group-sm">
            <a href="{{ url_for('domains.list_domains', q=q, status=status_filter, type=type_filter, parent=parent_filter, cert_type=cert_type_filter, ca=ca_filter, ssl_status=ssl_status_filter, expiry_range=expiry_range_filter) }}" class="btn btn-outline-secondary {% if not group_by %}active{% endif %}">Flat</a>
            <a href="{{ url_for('domains.list_domains', q=q, status=status_filter, type=type_filter, parent=parent_filter, cert_type=cert_type_filter, ca=ca_filter, ssl_status=ssl_status_filter, expiry_range=expiry_range_filter, group_by='parent') }}" class="btn btn-outline-secondary {% if group_by == 'parent' %}active{% endif %}">By Parent</a>
            <a href="{{ url_for('domains.list_domains', q=q, status=status_filter, type=type_filter, parent=parent_filter, cert_type=cert_type_filter, ca=ca_filter, ssl_status=ssl_status_filter, expiry_range=expiry_range_filter, group_by='tag') }}" class="btn btn-outline-secondary {% if group_by == 'tag' %}active{% endif %}">By Tag</a>
        </div>
    </div>
</form>

{% if grouped_domains %}
{% for group_name, group_domains in grouped_domains.items() %}
<div class="card mb-3">
    <div class="card-header" data-bs-toggle="collapse" data-bs-target="#group-{{ loop.index }}" style="cursor:pointer;">
        <strong>{{ group_name }}</strong>
        <span class="badge bg-secondary ms-2">{{ group_domains|length }}</span>
        <i class="bi bi-chevron-down float-end"></i>
    </div>
    <div id="group-{{ loop.index }}" class="collapse show">
        <div class="card-body table-responsive p-0">
            <table class="table table-sm table-hover mb-0">
                <thead>
                    <tr>
                        <th>Hostname</th><th>Type</th><th>SSL Status</th><th>SSL Expiry</th><th>Days Left</th><th>CA</th><th>IP</th><th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for d in group_domains %}
                    <tr>
                        <td><a href="{{ url_for('domains.detail', domain_id=d.domain_id) }}" class="fw-semibold text-decoration-none">{{ d.hostname }}</a></td>
                        <td><span class="badge bg-light text-dark">{{ d.domain_type.value|title }}</span></td>
                        <td>
                            {% if d.ssl_status == 'ok' %}<span class="badge bg-success">OK</span>
                            {% elif d.ssl_status == 'warning' %}<span class="badge bg-warning text-dark">WARNING</span>
                            {% elif d.ssl_status == 'expired' %}<span class="badge bg-danger">EXPIRED</span>
                            {% elif d.ssl_status == 'fail' %}<span class="badge bg-dark">FAIL</span>
                            {% else %}<span class="badge bg-secondary">-</span>{% endif %}
                        </td>
                        <td>{{ d.ssl_expiry.strftime('%Y-%m-%d') if d.ssl_expiry else '-' }}</td>
                        <td>
                            {% if d.ssl_days_remaining is not none %}
                            <span class="text-{{ 'danger' if d.ssl_status == 'expired' else 'warning' if d.ssl_status == 'warning' else 'success' }}">{{ d.ssl_days_remaining }}d</span>
                            {% else %}-{% endif %}
                        </td>
                        <td><small>{{ d.ssl_ca_name or '-' }}</small></td>
                        <td><code>{{ d.ip_address or '-' }}</code></td>
                        <td class="text-end" style="white-space:nowrap;">
                            <form method="post" action="{{ url_for('domains.refresh_domain', domain_id=d.domain_id) }}" style="display:inline">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="btn btn-sm btn-outline-primary" title="Refresh"><i class="bi bi-arrow-clockwise"></i></button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endfor %}

{% elif domains %}
<div class="card">
    <div class="card-body table-responsive">
        <table class="table table-sm table-hover mb-0">
            {% from "macros/sort_header.html" import sort_th with context %}
            <thead>
                <tr>
                    {{ sort_th("Hostname", "hostname", sort_field, sort_order) }}
                    {{ sort_th("Type", "type", sort_field, sort_order) }}
                    {{ sort_th("Cert Type", "cert_type", sort_field, sort_order) }}
                    {{ sort_th("CA", "ca", sort_field, sort_order) }}
                    {{ sort_th("IP Address", "ip", sort_field, sort_order) }}
                    {{ sort_th("SSL Status", "ssl_status", sort_field, sort_order) }}
                    {{ sort_th("SSL Expiry", "ssl_expiry", sort_field, sort_order) }}
                    {{ sort_th("Days Left", "days_left", sort_field, sort_order) }}
                    {{ sort_th("Domain Expiry", "domain_expiry", sort_field, sort_order) }}
                    {{ sort_th("Hosting", "hosting", sort_field, sort_order) }}
                    {{ sort_th("Last Checked", "last_checked", sort_field, sort_order) }}
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for d in domains %}
                <tr>
                    <td>
                        <a href="{{ url_for('domains.detail', domain_id=d.domain_id) }}" class="fw-semibold text-decoration-none">
                            {{ d.hostname }}
                        </a>
                        {% if d.auto_discovered %}<span class="badge bg-light text-muted ms-1" title="Auto-discovered">{% if 'azure-dns' in d.tags %}azure{% elif 'zone-transfer' in d.tags %}axfr{% else %}auto{% endif %}</span>{% endif %}
                    </td>
                    <td><span class="badge bg-light text-dark">{{ d.domain_type.value|title }}</span></td>
                    <td>
                        {% if d.ssl_certificate_type.value == 'wildcard' %}
                        <span class="badge bg-info text-dark">Wildcard</span>
                        {% elif d.ssl_certificate_type.value == 'san' %}
                        <span class="badge bg-purple text-white" style="background-color:#6f42c1!important;">SAN</span>
                        {% elif d.ssl_certificate_type.value == 'single' %}
                        <span class="badge bg-secondary">Single</span>
                        {% else %}
                        <span class="badge bg-light text-muted">-</span>
                        {% endif %}
                    </td>
                    <td><small>{{ d.ssl_ca_name or '-' }}</small></td>
                    <td><code>{{ d.ip_address or '-' }}</code></td>
                    <td>
                        {% if d.ssl_status == 'ok' %}
                        <span class="badge bg-success">OK</span>
                        {% elif d.ssl_status == 'warning' %}
                        <span class="badge bg-warning text-dark">WARNING</span>
                        {% elif d.ssl_status == 'expired' %}
                        <span class="badge bg-danger">EXPIRED</span>
                        {% elif d.ssl_status == 'fail' %}
                        <span class="badge bg-dark">FAIL</span>
                        {% else %}
                        <span class="badge bg-secondary">-</span>
                        {% endif %}
                    </td>
                    <td>{{ d.ssl_expiry.strftime('%Y-%m-%d') if d.ssl_expiry else '-' }}</td>
                    <td>
                        {% if d.ssl_days_remaining is not none %}
                        <span class="text-{{ 'danger' if d.ssl_status == 'expired' else 'warning' if d.ssl_status == 'warning' else 'success' }}">
                            {{ d.ssl_days_remaining }}d
                        </span>
                        {% else %}-{% endif %}
                    </td>
                    <td>
                        {% if d.registration_expiry %}
                        <span class="text-{{ 'danger' if d.registration_days_remaining is not none and d.registration_days_remaining < 30 else 'warning' if d.registration_days_remaining is not none and d.registration_days_remaining < 90 else 'success' }}">
                            {{ d.registration_expiry.strftime('%Y-%m-%d') }}
                        </span>
                        {% if d.registration_days_remaining is not none %}<small class="text-muted"> ({{ d.registration_days_remaining }}d)</small>{% endif %}
                        {% else %}-{% endif %}
                    </td>
                    <td><small>{{ d.hosting_provider or '-' }}</small></td>
                    <td><small class="text-muted">{{ d.last_checked.strftime('%Y-%m-%d %H:%M') if d.last_checked else 'never' }}</small></td>
                    <td class="text-end" style="white-space:nowrap;">
                        <form method="post" action="{{ url_for('domains.refresh_domain', domain_id=d.domain_id) }}" style="display:inline">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="btn btn-sm btn-outline-primary" title="Refresh" aria-label="Refresh {{ d.hostname }}"><i class="bi bi-arrow-clockwise"></i></button>
                        </form>
                        <form method="post" action="{{ url_for('domains.delete_domain', domain_id=d.domain_id) }}" style="display:inline" data-confirm="Delete {{ d.hostname }}?">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete" aria-label="Delete {{ d.hostname }}"><i class="bi bi-trash"></i></button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% else %}
<div class="card">
    <div class="card-body">
        <div class="empty-state">
            <i class="bi bi-globe2"></i>
            <p>No domains tracked yet.</p>
            <a href="{{ url_for('domains.add_domain') }}" class="btn btn-primary"><i class="bi bi-plus-lg"></i> Add Your First Domain</a>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}
