{% extends "base.html" %}
{% block title %}Audit Log{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h4><i class="bi bi-journal-text"></i> Audit Log</h4>
</div>

<form method="get" class="filter-bar row g-2 mb-4 align-items-center">
    <div class="col-auto">
        <input type="text" name="q" class="form-control form-control-sm" placeholder="Search target..." value="{{ q }}" style="width:180px;">
    </div>
    <div class="col-auto">
        <input type="text" name="user" class="form-control form-control-sm" placeholder="Filter by user..." value="{{ user_filter }}" style="width:150px;">
    </div>
    <div class="col-auto">
        <select name="action" class="form-select form-select-sm">
            <option value="">All Actions</option>
            {% for a in AuditAction %}
            <option value="{{ a.value }}" {% if action_filter == a.value %}selected{% endif %}>{{ a.value|replace('_', ' ')|title }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="col-auto">
        <button type="submit" class="btn btn-outline-secondary btn-sm">Filter</button>
        {% if q or action_filter or user_filter %}
        <a href="{{ url_for('audit.list_entries') }}" class="btn btn-outline-secondary btn-sm">Clear</a>
        {% endif %}
    </div>
</form>

{% if entries %}
<div class="card">
    <div class="card-header"><i class="bi bi-list-ul"></i> {{ entries|length }} entries</div>
    <div class="card-body table-responsive">
        <table class="table table-sm table-hover mb-0">
            {% from "macros/sort_header.html" import sort_th with context %}
            <thead>
                <tr>
                    {{ sort_th("Timestamp", "timestamp", sort_field, sort_order) }}
                    {{ sort_th("User", "user", sort_field, sort_order) }}
                    {{ sort_th("Action", "action", sort_field, sort_order) }}
                    {{ sort_th("Target", "target", sort_field, sort_order) }}
                    <th>Detail</th>
                </tr>
            </thead>
            <tbody>
                {% for e in entries %}
                <tr>
                    <td><small class="text-muted">{{ e.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</small></td>
                    <td><small>{{ e.user or 'â€”' }}</small></td>
                    <td>
                        {% set action_colors = {
                            'domain_add': 'success', 'domain_delete': 'danger', 'domain_edit': 'info',
                            'domain_refresh': 'primary', 'domain_bulk_refresh': 'primary',
                            'domain_import': 'success', 'azure_scan': 'info',
                            'certificate_issue': 'success', 'certificate_renew': 'warning',
                            'alert_acknowledge': 'secondary', 'settings_change': 'dark',
                            'export': 'secondary', 'scheduled_check': 'primary', 'auto_renewal': 'warning',
                            'user_login': 'info', 'user_logout': 'secondary', 'user_add': 'success', 'user_delete': 'danger', 'user_edit': 'info'
                        } %}
                        <span class="badge bg-{{ action_colors.get(e.action.value, 'secondary') }}">{{ e.action.value|replace('_', ' ')|title }}</span>
                    </td>
                    <td class="fw-semibold">{{ e.target }}</td>
                    <td><small>{{ e.detail }}</small></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% else %}
<div class="card">
    <div class="card-body">
        <div class="empty-state">
            <i class="bi bi-journal-text"></i>
            <p>No audit entries yet.</p>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}
